<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>最佳实践 &mdash; 国内最专业的Ansible中文官方学习手册</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Playbooks: Special Topics" href="playbooks_special_topics.html" />
    <link rel="prev" title="循环" href="playbooks_loops.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Ansible中文权威指南
          </a>
              <div class="version">
                5.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">总体介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">快速学习视频</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="playbooks.html">Playbooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="playbooks_intro.html">Playbooks 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_roles.html">Playbook 角色(Roles) 和 Include 语句</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_conditionals.html">条件选择</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_loops.html">循环</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">最佳实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#content-organization-1">Content Organization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#directory-layout-1">Directory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-dynamic-inventory-with-clouds-1">Use Dynamic Inventory With Clouds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-differentiate-stage-vs-production">How to Differentiate  Stage vs Production</a></li>
<li class="toctree-l4"><a class="reference internal" href="#group-and-host-variables">Group And Host Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#top-level-playbooks-are-separated-by-role">Top Level Playbooks Are Separated By Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-and-handler-organization-for-a-role">Task And Handler Organization For A Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-this-organization-enables-examples">What This Organization Enables (Examples)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deployment-vs-configuration-organization">Deployment vs Configuration Organization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stage-vs-production-1">Stage vs Production</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rolling-updates">Rolling Updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#always-mention-the-state">Always Mention The State</a></li>
<li class="toctree-l3"><a class="reference internal" href="#group-by-roles-1">Group By Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operating-system-and-distribution-variance">Operating System and Distribution Variance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bundling-ansible-modules-with-playbooks">Bundling Ansible Modules With Playbooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#whitespace-and-comments">Whitespace and Comments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#always-name-tasks">Always Name Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keep-it-simple-1">Keep It Simple</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-control-1">Version Control</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="playbooks_special_topics.html">Playbooks: Special Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">模块相关</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides.html">详细指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">开发者须知</a></li>
<li class="toctree-l1"><a class="reference internal" href="tower.html">Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Ansible用户</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html#section-4">对当前和未来的开发人员</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html#section-5">其它主题</a></li>
<li class="toctree-l1"><a class="reference internal" href="galaxy.html">Ansible Galaxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_strategies.html">测试策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="YAMLSyntax.html">YAML 语法</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible中文权威指南</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="playbooks.html">Playbooks</a></li>
      <li class="breadcrumb-item active">最佳实践</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/docs/playbooks_best_practices.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="section-1">
<h1><a class="toc-backref" href="#toc-entry-1" role="doc-backlink">最佳实践</a><a class="headerlink" href="#section-1" title="Permalink to this headline">¶</a></h1>
<p>这里有些给使用和编写 Ansible playbook 的贴士.</p>
<p>你能在我们的 <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-example repository</a>.找到展示这些最佳实践的 playbook 样例.(注意: 这些示例用的也许不是最新版的中所有特性,但它们仍旧是极佳的参考.)</p>
<nav class="contents" id="topics">
<p class="topic-title">Topics</p>
<ul class="simple">
<li><p><a class="reference internal" href="#section-1" id="toc-entry-1">最佳实践</a></p>
<ul>
<li><p><a class="reference internal" href="#content-organization-1" id="toc-entry-2">Content Organization</a></p>
<ul>
<li><p><a class="reference internal" href="#directory-layout-1" id="toc-entry-3">Directory Layout</a></p></li>
<li><p><a class="reference internal" href="#use-dynamic-inventory-with-clouds-1" id="toc-entry-4">Use Dynamic Inventory With Clouds</a></p></li>
<li><p><a class="reference internal" href="#how-to-differentiate-stage-vs-production" id="toc-entry-5">How to Differentiate  Stage vs Production</a></p></li>
<li><p><a class="reference internal" href="#group-and-host-variables" id="toc-entry-6">Group And Host Variables</a></p></li>
<li><p><a class="reference internal" href="#top-level-playbooks-are-separated-by-role" id="toc-entry-7">Top Level Playbooks Are Separated By Role</a></p></li>
<li><p><a class="reference internal" href="#task-and-handler-organization-for-a-role" id="toc-entry-8">Task And Handler Organization For A Role</a></p></li>
<li><p><a class="reference internal" href="#what-this-organization-enables-examples" id="toc-entry-9">What This Organization Enables (Examples)</a></p></li>
<li><p><a class="reference internal" href="#deployment-vs-configuration-organization" id="toc-entry-10">Deployment vs Configuration Organization</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#stage-vs-production-1" id="toc-entry-11">Stage vs Production</a></p></li>
<li><p><a class="reference internal" href="#rolling-updates" id="toc-entry-12">Rolling Updates</a></p></li>
<li><p><a class="reference internal" href="#always-mention-the-state" id="toc-entry-13">Always Mention The State</a></p></li>
<li><p><a class="reference internal" href="#group-by-roles-1" id="toc-entry-14">Group By Roles</a></p></li>
<li><p><a class="reference internal" href="#operating-system-and-distribution-variance" id="toc-entry-15">Operating System and Distribution Variance</a></p></li>
<li><p><a class="reference internal" href="#bundling-ansible-modules-with-playbooks" id="toc-entry-16">Bundling Ansible Modules With Playbooks</a></p></li>
<li><p><a class="reference internal" href="#whitespace-and-comments" id="toc-entry-17">Whitespace and Comments</a></p></li>
<li><p><a class="reference internal" href="#always-name-tasks" id="toc-entry-18">Always Name Tasks</a></p></li>
<li><p><a class="reference internal" href="#keep-it-simple-1" id="toc-entry-19">Keep It Simple</a></p></li>
<li><p><a class="reference internal" href="#version-control-1" id="toc-entry-20">Version Control</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="content-organization-1">
<span id="content-organization"></span><h2><a class="toc-backref" href="#toc-entry-2" role="doc-backlink">Content Organization</a><a class="headerlink" href="#content-organization-1" title="Permalink to this headline">¶</a></h2>
<p>接下来的章节将向你展示一种组织 playbook 内容方式.</p>
<p>你对 Ansible 的使用应该符合你的需求而不是我们的,所以请随意根据你的需求来组织修改接下来的示例.</p>
<p>有件事绝对是你想要做的,那就是使用 “roles” 组织特性.它作为主要的 playbook 的主要部分被文档化.详情参见 <a class="reference internal" href="playbooks_roles.html"><span class="doc">Playbook 角色(Roles) 和 Include 语句</span></a>. 你绝对应该使用 roles.
roles 是极好的. 快去使用 roles！ roles！ 重要的事情要重复说！roles 是极好的.(译者:..老外也知道重要的事情重复三遍啊！~~~)</p>
<section id="directory-layout-1">
<span id="directory-layout"></span><h3><a class="toc-backref" href="#toc-entry-3" role="doc-backlink">Directory Layout</a><a class="headerlink" href="#directory-layout-1" title="Permalink to this headline">¶</a></h3>
<p>顶层目录结构应当包括下列文件和目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">production</span>                <span class="c1"># inventory file for production servers 关于生产环境服务器的清单文件</span>
<span class="n">stage</span>                     <span class="c1"># inventory file for stage environment 关于 stage 环境的清单文件</span>

<span class="n">group_vars</span><span class="o">/</span>
   <span class="n">group1</span>                 <span class="c1"># here we assign variables to particular groups 这里我们给特定的组赋值</span>
   <span class="n">group2</span>                 <span class="c1"># &quot;&quot;</span>
<span class="n">host_vars</span><span class="o">/</span>
   <span class="n">hostname1</span>              <span class="c1"># if systems need specific variables, put them here 如果系统需要特定的变量,把它们放置在这里.</span>
   <span class="n">hostname2</span>              <span class="c1"># &quot;&quot;</span>

<span class="n">library</span><span class="o">/</span>                  <span class="c1"># if any custom modules, put them here (optional) 如果有自定义的模块,放在这里(可选)</span>
<span class="n">filter_plugins</span><span class="o">/</span>           <span class="c1"># if any custom filter plugins, put them here (optional) 如果有自定义的过滤插件,放在这里(可选)</span>

<span class="n">site</span><span class="o">.</span><span class="n">yml</span>                  <span class="c1"># master playbook 主 playbook</span>
<span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>            <span class="c1"># playbook for webserver tier Web 服务器的 playbook</span>
<span class="n">dbservers</span><span class="o">.</span><span class="n">yml</span>             <span class="c1"># playbook for dbserver tier 数据库服务器的 playbook</span>

<span class="n">roles</span><span class="o">/</span>
    <span class="n">common</span><span class="o">/</span>               <span class="c1"># this hierarchy represents a &quot;role&quot; 这里的结构代表了一个 &quot;role&quot;</span>
        <span class="n">tasks</span><span class="o">/</span>            <span class="c1">#</span>
            <span class="n">main</span><span class="o">.</span><span class="n">yml</span>      <span class="c1">#  &lt;-- tasks file can include smaller files if warranted</span>
        <span class="n">handlers</span><span class="o">/</span>         <span class="c1">#</span>
            <span class="n">main</span><span class="o">.</span><span class="n">yml</span>      <span class="c1">#  &lt;-- handlers file</span>
        <span class="n">templates</span><span class="o">/</span>        <span class="c1">#  &lt;-- files for use with the template resource</span>
            <span class="n">ntp</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">j2</span>   <span class="c1">#  &lt;------- templates end in .j2</span>
        <span class="n">files</span><span class="o">/</span>            <span class="c1">#</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">txt</span>       <span class="c1">#  &lt;-- files for use with the copy resource</span>
            <span class="n">foo</span><span class="o">.</span><span class="n">sh</span>        <span class="c1">#  &lt;-- script files for use with the script resource</span>
        <span class="nb">vars</span><span class="o">/</span>             <span class="c1">#</span>
            <span class="n">main</span><span class="o">.</span><span class="n">yml</span>      <span class="c1">#  &lt;-- variables associated with this role</span>
        <span class="n">defaults</span><span class="o">/</span>         <span class="c1">#</span>
            <span class="n">main</span><span class="o">.</span><span class="n">yml</span>      <span class="c1">#  &lt;-- default lower priority variables for this role</span>
        <span class="n">meta</span><span class="o">/</span>             <span class="c1">#</span>
            <span class="n">main</span><span class="o">.</span><span class="n">yml</span>      <span class="c1">#  &lt;-- role dependencies</span>

    <span class="n">webtier</span><span class="o">/</span>              <span class="c1"># same kind of structure as &quot;common&quot; was above, done for the webtier role</span>
    <span class="n">monitoring</span><span class="o">/</span>           <span class="c1"># &quot;&quot;</span>
    <span class="n">fooapp</span><span class="o">/</span>               <span class="c1"># &quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="use-dynamic-inventory-with-clouds-1">
<span id="use-dynamic-inventory-with-clouds"></span><h3><a class="toc-backref" href="#toc-entry-4" role="doc-backlink">Use Dynamic Inventory With Clouds</a><a class="headerlink" href="#use-dynamic-inventory-with-clouds-1" title="Permalink to this headline">¶</a></h3>
<p>如果你正在使用云服务,你不应该在一个静态文件管理你的清单.详见 <a class="reference internal" href="intro_dynamic_inventory.html"><span class="doc">动态 Inventory</span></a>.</p>
<p>这不仅适用于云环境 – 如果你的基础设施中还有其他系统维护着一系列标准系统,使用 动态清单 会是个好主意.</p>
</section>
<section id="how-to-differentiate-stage-vs-production">
<span id="stage-vs-prod"></span><h3><a class="toc-backref" href="#toc-entry-5" role="doc-backlink">How to Differentiate  Stage vs Production</a><a class="headerlink" href="#how-to-differentiate-stage-vs-production" title="Permalink to this headline">¶</a></h3>
<p>If managing static inventory, it is frequently asked how to differentiate different types of environments.  The following example
shows a good way to do this.  Similar methods of grouping could be adapted to dynamic inventory (for instance, consider applying the AWS
tag “environment:production”, and you’ll get a group of systems automatically discovered named “ec2_tag_environment_production”.</p>
<p>如果你管理着静态清单,如何区分不同的环境类型是个常见的问题.接下来的示例会做一个很好地说明.</p>
<p>Let’s show a static inventory example though.  Below, the <em>production</em> file contains the inventory of all of your production hosts.</p>
<p>It is suggested that you define groups based on purpose of the host (roles) and also geography or datacenter location (if applicable):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># file: production</span>

<span class="p">[</span><span class="n">atlanta</span><span class="o">-</span><span class="n">webservers</span><span class="p">]</span>
<span class="n">www</span><span class="o">-</span><span class="n">atl</span><span class="o">-</span><span class="mf">1.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">www</span><span class="o">-</span><span class="n">atl</span><span class="o">-</span><span class="mf">2.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="p">[</span><span class="n">boston</span><span class="o">-</span><span class="n">webservers</span><span class="p">]</span>
<span class="n">www</span><span class="o">-</span><span class="n">bos</span><span class="o">-</span><span class="mf">1.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">www</span><span class="o">-</span><span class="n">bos</span><span class="o">-</span><span class="mf">2.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="p">[</span><span class="n">atlanta</span><span class="o">-</span><span class="n">dbservers</span><span class="p">]</span>
<span class="n">db</span><span class="o">-</span><span class="n">atl</span><span class="o">-</span><span class="mf">1.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">db</span><span class="o">-</span><span class="n">atl</span><span class="o">-</span><span class="mf">2.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="p">[</span><span class="n">boston</span><span class="o">-</span><span class="n">dbservers</span><span class="p">]</span>
<span class="n">db</span><span class="o">-</span><span class="n">bos</span><span class="o">-</span><span class="mf">1.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="c1"># webservers in all geos</span>
<span class="p">[</span><span class="n">webservers</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">atlanta</span><span class="o">-</span><span class="n">webservers</span>
<span class="n">boston</span><span class="o">-</span><span class="n">webservers</span>

<span class="c1"># dbservers in all geos</span>
<span class="p">[</span><span class="n">dbservers</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">atlanta</span><span class="o">-</span><span class="n">dbservers</span>
<span class="n">boston</span><span class="o">-</span><span class="n">dbservers</span>

<span class="c1"># everything in the atlanta geo</span>
<span class="p">[</span><span class="n">atlanta</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">atlanta</span><span class="o">-</span><span class="n">webservers</span>
<span class="n">atlanta</span><span class="o">-</span><span class="n">dbservers</span>

<span class="c1"># everything in the boston geo</span>
<span class="p">[</span><span class="n">boston</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">boston</span><span class="o">-</span><span class="n">webservers</span>
<span class="n">boston</span><span class="o">-</span><span class="n">dbservers</span>
</pre></div>
</div>
</section>
<section id="group-and-host-variables">
<span id="groups-and-hosts"></span><h3><a class="toc-backref" href="#toc-entry-6" role="doc-backlink">Group And Host Variables</a><a class="headerlink" href="#group-and-host-variables" title="Permalink to this headline">¶</a></h3>
<p>本章节内容基于前一章节示例.</p>
<p>分组有利于组织结构,但不是所有的分组都是有益的.你也可以给他们赋值!比如说亚特兰大有它自己的网络时间协议,
所以当配置 ntp.conf 时,我们就该使用它.让我们现在设置它们:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: group_vars/atlanta</span>
<span class="n">ntp</span><span class="p">:</span> <span class="n">ntp</span><span class="o">-</span><span class="n">atlanta</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">backup</span><span class="p">:</span> <span class="n">backup</span><span class="o">-</span><span class="n">atlanta</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>Variables aren’t just for geographic information either!  Maybe the webservers have some configuration that doesn’t make sense for the database servers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: group_vars/webservers</span>
<span class="n">apacheMaxRequestsPerChild</span><span class="p">:</span> <span class="mi">3000</span>
<span class="n">apacheMaxClients</span><span class="p">:</span> <span class="mi">900</span>
</pre></div>
</div>
<p>If we had any default values, or values that were universally true, we would put them in a file called group_vars/all:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: group_vars/all</span>
<span class="n">ntp</span><span class="p">:</span> <span class="n">ntp</span><span class="o">-</span><span class="n">boston</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">backup</span><span class="p">:</span> <span class="n">backup</span><span class="o">-</span><span class="n">boston</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>We can define specific hardware variance in systems in a host_vars file, but avoid doing this unless you need to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: host_vars/db-bos-1.example.com</span>
<span class="n">foo_agent_port</span><span class="p">:</span> <span class="mi">86</span>
<span class="n">bar_agent_port</span><span class="p">:</span> <span class="mi">99</span>
</pre></div>
</div>
<p>Again, if we are using dynamic inventory sources, many dynamic groups are automatically created.  So a tag like “class:webserver” would load in
variables from the file “group_vars/ec2_tag_class_webserver” automatically.</p>
</section>
<section id="top-level-playbooks-are-separated-by-role">
<span id="split-by-role"></span><h3><a class="toc-backref" href="#toc-entry-7" role="doc-backlink">Top Level Playbooks Are Separated By Role</a><a class="headerlink" href="#top-level-playbooks-are-separated-by-role" title="Permalink to this headline">¶</a></h3>
<p>在 site.yml 中,我们包含了一个定义了整个基础设施的 playbook.注意这个 playbook 是非常短的,
因为它仅仅包含了其他 playbooks.记住, playbook 不过就是一系列的 <cite>plays</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: site.yml</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">dbservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>在诸如 like webservers.yml 的文件中(同样也在顶层结构),我们仅仅将 Web 服务器组与对应的 role 行为做映射.同样值得注意的是这也非常的短小精悍.例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: webservers.yml</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">common</span>
    <span class="o">-</span> <span class="n">webtier</span>
</pre></div>
</div>
<p>理念是我们能够通过 “运行”(running) site.yml 来选择整个基础设施的配置.或者我们能够通过运行其子集 webservers.yml 来配置.
这与 Ansible 的 “–limit” 类似,而且相对的更为显式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="n">webservers</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</section>
<section id="task-and-handler-organization-for-a-role">
<span id="role-organization"></span><h3><a class="toc-backref" href="#toc-entry-8" role="doc-backlink">Task And Handler Organization For A Role</a><a class="headerlink" href="#task-and-handler-organization-for-a-role" title="Permalink to this headline">¶</a></h3>
<p>接下来的示例任务文件展示了一个 role 是如何工作的.我们这里的普通 role 仅仅用来配置 NTP,但是如果我们想的话,它可以做更多:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: roles/common/tasks/main.yml</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">be</span> <span class="n">sure</span> <span class="n">ntp</span> <span class="ow">is</span> <span class="n">installed</span>
  <span class="n">yum</span><span class="p">:</span> <span class="n">pkg</span><span class="o">=</span><span class="n">ntp</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>
  <span class="n">tags</span><span class="p">:</span> <span class="n">ntp</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">be</span> <span class="n">sure</span> <span class="n">ntp</span> <span class="ow">is</span> <span class="n">configured</span>
  <span class="n">template</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">j2</span> <span class="n">dest</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">ntp</span><span class="o">.</span><span class="n">conf</span>
  <span class="n">notify</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">restart</span> <span class="n">ntpd</span>
  <span class="n">tags</span><span class="p">:</span> <span class="n">ntp</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">be</span> <span class="n">sure</span> <span class="n">ntpd</span> <span class="ow">is</span> <span class="n">running</span> <span class="ow">and</span> <span class="n">enabled</span>
  <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">ntpd</span> <span class="n">state</span><span class="o">=</span><span class="n">running</span> <span class="n">enabled</span><span class="o">=</span><span class="n">yes</span>
  <span class="n">tags</span><span class="p">:</span> <span class="n">ntp</span>
</pre></div>
</div>
<p>这是个处理文件样例.作为一种审核,它只有当特定的任务报告发生变化时会被触发,并在每个 play 结束时运行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: roles/common/handlers/main.yml</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">ntpd</span>
  <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">ntpd</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
</pre></div>
</div>
<p>详情请参阅 <a class="reference internal" href="playbooks_roles.html"><span class="doc">Playbook 角色(Roles) 和 Include 语句</span></a>.</p>
</section>
<section id="what-this-organization-enables-examples">
<span id="organization-examples"></span><h3><a class="toc-backref" href="#toc-entry-9" role="doc-backlink">What This Organization Enables (Examples)</a><a class="headerlink" href="#what-this-organization-enables-examples" title="Permalink to this headline">¶</a></h3>
<p>我们在前文分享了我们基础的组织结构.</p>
<p>那这种结构适用于何种应用场景？ 很多！若我想重新配置整个基础设施,如此即可:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>那只重新配置所有的 NTP 呢？太容易了.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">tags</span> <span class="n">ntp</span>
</pre></div>
</div>
<p>只重新配置我的 Web 服务器呢？:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>只重新配置我在波士顿的 Web服务器呢?:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="n">boston</span>
</pre></div>
</div>
<p>前10台 和 接下来的10台呢？</p>
<blockquote>
<div><p>ansible-playbook -i production webservers.yml –limit boston[0-10]
ansible-playbook -i production webservers.yml –limit boston[10-20]</p>
</div></blockquote>
<p>当然,只使用基础的 ad-hoc 也是 OK 的啦.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="n">boston</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="o">-</span><span class="n">m</span> <span class="n">ping</span>
<span class="n">ansible</span> <span class="n">boston</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="o">-</span><span class="n">m</span> <span class="n">command</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;/sbin/reboot&#39;</span>
</pre></div>
</div>
<p>这里还有些有用的命令你需要知道(版本至少 1.1 或更高):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># confirm what task names would be run if I ran this command and said &quot;just ntp tasks&quot;</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">tags</span> <span class="n">ntp</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">tasks</span>

<span class="c1"># confirm what hostnames might be communicated with if I said &quot;limit to boston&quot;</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">production</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="n">boston</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">hosts</span>
</pre></div>
</div>
</section>
<section id="deployment-vs-configuration-organization">
<span id="dep-vs-config"></span><h3><a class="toc-backref" href="#toc-entry-10" role="doc-backlink">Deployment vs Configuration Organization</a><a class="headerlink" href="#deployment-vs-configuration-organization" title="Permalink to this headline">¶</a></h3>
<p>The above setup models a typical configuration topology.  When doing multi-tier deployments, there are going
to be some additional playbooks that hop between tiers to roll out an application.  In this case, ‘site.yml’
may be augmented by playbooks like ‘deploy_exampledotcom.yml’ but the general concepts can still apply.</p>
<p>Consider “playbooks” as a sports metaphor – you don’t have to just have one set of plays to use against your infrastructure
all the time – you can have situational plays that you use at different times and for different purposes.</p>
<p>Ansible allows you to deploy and configure using the same tool, so you would likely reuse groups and just
keep the OS configuration in separate playbooks from the app deployment.</p>
</section>
</section>
<section id="stage-vs-production-1">
<span id="stage-vs-production"></span><h2><a class="toc-backref" href="#toc-entry-11" role="doc-backlink">Stage vs Production</a><a class="headerlink" href="#stage-vs-production-1" title="Permalink to this headline">¶</a></h2>
<p>如前所述,通过使用不同的清单文件来分离你的 stage 和 生产环境是个好方法.你可以通过 -i 来指定.把它们放在同一个文件中会有惊喜哦！
在部署到生产环境之前,先在 stage 环境中做测试是个好主意.你的环境不必保持同样的大小,你可以通过 分组变量来对不同的环境进行控制.</p>
</section>
<section id="rolling-updates">
<span id="rolling-update"></span><h2><a class="toc-backref" href="#toc-entry-12" role="doc-backlink">Rolling Updates</a><a class="headerlink" href="#rolling-updates" title="Permalink to this headline">¶</a></h2>
<p>请理解 ‘serial’ 关键字.你会在批量升级中使用它来控制升级机器的数量.</p>
<p>See <a class="reference internal" href="playbooks_delegation.html"><span class="doc">委托,滚动更新,本地动作</span></a>.</p>
</section>
<section id="always-mention-the-state">
<span id="mention-the-state"></span><h2><a class="toc-backref" href="#toc-entry-13" role="doc-backlink">Always Mention The State</a><a class="headerlink" href="#always-mention-the-state" title="Permalink to this headline">¶</a></h2>
<p>parameter in your playbooks to make it clear, especially as some modules support additional states.
对于很多模块来说 ‘state’ 参数是可选的.无论是 ‘state=present’ 亦或 ‘state=absent’ ,你最好在 playbook 中显式指定该参数,毕竟有些模块是支持附加的 ‘state’ 参数.</p>
</section>
<section id="group-by-roles-1">
<span id="group-by-roles"></span><h2><a class="toc-backref" href="#toc-entry-14" role="doc-backlink">Group By Roles</a><a class="headerlink" href="#group-by-roles-1" title="Permalink to this headline">¶</a></h2>
<p>在这条贴士中,我们某种程度上在重复自己,但这是值得的.一个系统可能被分成多分组.详情请查阅 <a class="reference internal" href="intro_inventory.html"><span class="doc">Inventory文件</span></a> 和 <a class="reference internal" href="intro_patterns.html"><span class="doc">Patterns</span></a>.
在样例中,分组名之后的 <em>webservers</em> 和 <em>dbservers</em> ,它们因为是很重要的概念所以反复出现.(译者:恩,重要的事情要重复三遍！)一个系统可以出现在多个分组中.</p>
<p>通过给 role 赋予特定的变量,这允许 playbooks 能基于角色来锁定机器.</p>
<p>See <a class="reference internal" href="playbooks_roles.html"><span class="doc">Playbook 角色(Roles) 和 Include 语句</span></a>.</p>
</section>
<section id="operating-system-and-distribution-variance">
<span id="os-variance"></span><h2><a class="toc-backref" href="#toc-entry-15" role="doc-backlink">Operating System and Distribution Variance</a><a class="headerlink" href="#operating-system-and-distribution-variance" title="Permalink to this headline">¶</a></h2>
<p>当处理在不同操作系统间参数值不同的参数时,使用 group_by 模块是个好主意.</p>
<p>这使宿主机的动态分组有了匹配的标准,即使该分组尚未在清单文件中被定义</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>

<span class="c1"># talk to all hosts just so we can learn about them</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">group_by</span><span class="p">:</span> <span class="n">key</span><span class="o">=</span><span class="n">os_</span><span class="p">{{</span> <span class="n">ansible_distribution</span> <span class="p">}}</span>

<span class="c1"># now just on the CentOS hosts...</span>

<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">os_CentOS</span>
  <span class="n">gather_facts</span><span class="p">:</span> <span class="kc">False</span>
  <span class="n">tasks</span><span class="p">:</span>
     <span class="o">-</span> <span class="c1"># tasks that only happen on CentOS go here</span>
</pre></div>
</div>
<p>这会抛出所有基于操作系统名的分组.</p>
<p>如果需要对特定分组做设定,这也是可以的.例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="c1"># file: group_vars/all</span>
<span class="n">asdf</span><span class="p">:</span> <span class="mi">10</span>

<span class="o">---</span>
<span class="c1"># file: group_vars/os_CentOS</span>
<span class="n">asdf</span><span class="p">:</span> <span class="mi">42</span>
</pre></div>
</div>
<p>在上述的例子中, CentOS 的机器获取的 asdf 的值为 42,但其他机器获得是 ‘10’.这不止可以用于设置变量,也可以将特定的 role 应用于特定的操作系统.</p>
<p>相对的,如果只需要变量:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">include_vars</span><span class="p">:</span> <span class="s2">&quot;os_{{ ansible_distribution }}.yml&quot;</span>
    <span class="o">-</span> <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">asdf</span>
</pre></div>
</div>
<p>这将根据操作系统名来拉取相应的值.</p>
</section>
<section id="bundling-ansible-modules-with-playbooks">
<span id="ship-modules-with-playbooks"></span><h2><a class="toc-backref" href="#toc-entry-16" role="doc-backlink">Bundling Ansible Modules With Playbooks</a><a class="headerlink" href="#bundling-ansible-modules-with-playbooks" title="Permalink to this headline">¶</a></h2>
<p>如果一个 playbook 有一个与它 YMAL 文件相关的 “./library” 目录,该目录可以用于添加 Ansible 模块,它会被自动添加到 Ansible 模块的路径中.这是一个将
playbook 与其模块放置在一起的方式.如下面的目录结构样例所展示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">_whitespace</span><span class="p">:</span>
</pre></div>
</div>
</section>
<section id="whitespace-and-comments">
<h2><a class="toc-backref" href="#toc-entry-17" role="doc-backlink">Whitespace and Comments</a><a class="headerlink" href="#whitespace-and-comments" title="Permalink to this headline">¶</a></h2>
<p>鼓励使用空格来分隔内容,用 ‘#’ 来写注释.</p>
</section>
<section id="always-name-tasks">
<span id="name-tasks"></span><h2><a class="toc-backref" href="#toc-entry-18" role="doc-backlink">Always Name Tasks</a><a class="headerlink" href="#always-name-tasks" title="Permalink to this headline">¶</a></h2>
<p>虽然推荐提供关于为什么要这么做的描述,但是直接给一个给定任务命名也是可以的.名字会在 playbook 运行时显示.</p>
</section>
<section id="keep-it-simple-1">
<span id="keep-it-simple"></span><h2><a class="toc-backref" href="#toc-entry-19" role="doc-backlink">Keep It Simple</a><a class="headerlink" href="#keep-it-simple-1" title="Permalink to this headline">¶</a></h2>
<p>当你能简单的搞定某事时,就简单的搞定.不要试图一次性使用 Ansible 的所有的特性.仅仅使用对你有用的即可.
比如说你基本上不会需要一次性使用 <code class="docutils literal notranslate"><span class="pre">vars</span></code> , <code class="docutils literal notranslate"><span class="pre">vars_files</span></code> , <code class="docutils literal notranslate"><span class="pre">vars_prompt</span></code> 和 <code class="docutils literal notranslate"><span class="pre">--extra-vars</span></code> 同时还是用一个外部的节点配置文件.</p>
<p>如果你感觉任务很复杂时,它可能真的很复杂,这也许是个简化它的好机会.</p>
</section>
<section id="version-control-1">
<span id="version-control"></span><h2><a class="toc-backref" href="#toc-entry-20" role="doc-backlink">Version Control</a><a class="headerlink" href="#version-control-1" title="Permalink to this headline">¶</a></h2>
<p>请使用版本控制.保持你的 playbook 和 清单文件 在 git(或其他版本控制系统)中,并将你的修改做提交.
这样你就有审计轨迹来描述什么时候以及为什么你做了这样的修改.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="YAMLSyntax.html"><span class="doc">YAML 语法</span></a></dt><dd><p>Learn about YAML syntax</p>
</dd>
<dt><a class="reference internal" href="playbooks.html"><span class="doc">Playbooks</span></a></dt><dd><p>Review the basic playbook features</p>
</dd>
<dt><a class="reference internal" href="modules.html"><span class="doc">模块相关</span></a></dt><dd><p>Learn about available modules</p>
</dd>
<dt><a class="reference internal" href="developing_modules.html"><span class="doc">Developing Modules</span></a></dt><dd><p>Learn how to extend Ansible by writing your own modules</p>
</dd>
<dt><a class="reference internal" href="intro_patterns.html"><span class="doc">Patterns</span></a></dt><dd><p>Learn about how to select hosts</p>
</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible/tree/devel/examples/playbooks">GitHub examples directory</a></dt><dd><p>Complete playbook files from the github project source</p>
</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt><dd><p>Questions? Help? Ideas?  Stop by the list on Google Groups</p>
</dd>
</dl>
</aside>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="playbooks_loops.html" class="btn btn-neutral float-left" title="循环" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="playbooks_special_topics.html" class="btn btn-neutral float-right" title="Playbooks: Special Topics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, http://www.magedu.com, 马哥Linux团队成员荣誉出品(薛定谔的章鱼 &amp; guli &amp; 以马内利 &amp; 黄博文 &amp; coocla &amp; 云中鹤 &amp; stanley) 官方QQ交流群:372011984.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>