<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction To Ad-Hoc Commands &mdash; 国内最专业的Ansible中文官方学习手册</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Ansible的配置文件" href="intro_configuration.html" />
    <link rel="prev" title="Patterns" href="intro_patterns.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Ansible中文权威指南
          </a>
              <div class="version">
                5.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="intro.html">总体介绍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro_installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_getting_started.html">新手上路</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_inventory.html">Inventory文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_dynamic_inventory.html">动态 Inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_patterns.html">Patterns</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction To Ad-Hoc Commands</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parallelism-and-shell-commands-1">Parallelism and Shell Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-transfer-1">File Transfer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#managing-packages-1">Managing Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#users-and-groups-1">Users and Groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploying-from-source-control">Deploying From Source Control</a></li>
<li class="toctree-l3"><a class="reference internal" href="#managing-services-1">Managing Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-limited-background-operations-1">Time Limited Background Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gathering-facts">Gathering Facts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="intro_configuration.html">Ansible的配置文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_windows.html">Windows Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">快速学习视频</a></li>
<li class="toctree-l1"><a class="reference internal" href="playbooks.html">Playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="playbooks_special_topics.html">Playbooks: Special Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">模块相关</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides.html">详细指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">开发者须知</a></li>
<li class="toctree-l1"><a class="reference internal" href="tower.html">Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Ansible用户</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html#section-4">对当前和未来的开发人员</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html#section-5">其它主题</a></li>
<li class="toctree-l1"><a class="reference internal" href="galaxy.html">Ansible Galaxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_strategies.html">测试策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="YAMLSyntax.html">YAML 语法</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible中文权威指南</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="intro.html">总体介绍</a></li>
      <li class="breadcrumb-item active">Introduction To Ad-Hoc Commands</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/docs/intro_adhoc.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction-to-ad-hoc-commands">
<h1><a class="toc-backref" href="#toc-entry-1" role="doc-backlink">Introduction To Ad-Hoc Commands</a><a class="headerlink" href="#introduction-to-ad-hoc-commands" title="Permalink to this headline">¶</a></h1>
<nav class="contents" id="topics">
<p class="topic-title">Topics</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction-to-ad-hoc-commands" id="toc-entry-1">Introduction To Ad-Hoc Commands</a></p>
<ul>
<li><p><a class="reference internal" href="#parallelism-and-shell-commands-1" id="toc-entry-2">Parallelism and Shell Commands</a></p></li>
<li><p><a class="reference internal" href="#file-transfer-1" id="toc-entry-3">File Transfer</a></p></li>
<li><p><a class="reference internal" href="#managing-packages-1" id="toc-entry-4">Managing Packages</a></p></li>
<li><p><a class="reference internal" href="#users-and-groups-1" id="toc-entry-5">Users and Groups</a></p></li>
<li><p><a class="reference internal" href="#deploying-from-source-control" id="toc-entry-6">Deploying From Source Control</a></p></li>
<li><p><a class="reference internal" href="#managing-services-1" id="toc-entry-7">Managing Services</a></p></li>
<li><p><a class="reference internal" href="#time-limited-background-operations-1" id="toc-entry-8">Time Limited Background Operations</a></p></li>
<li><p><a class="reference internal" href="#gathering-facts" id="toc-entry-9">Gathering Facts</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>在下面的例子中,我们将演示如何使用 <cite>/usr/bin/ansible</cite> 运行 ad hoc 任务.</p>
<p>所谓 ad-hoc 命令是什么呢?</p>
<p>(这其实是一个概念性的名字,是相对于写 Ansible playbook 来说的.类似于在命令行敲入shell命令和
写shell scripts两者之间的关系)…</p>
<p>如果我们敲入一些命令去比较快的完成一些事情,而不需要将这些执行的命令特别保存下来,
这样的命令就叫做 ad-hoc 命令.</p>
<p>Ansible提供两种方式去完成任务,一是 ad-hoc 命令,一是写 Ansible playbook.前者可以解决一些简单的任务,
后者解决较复杂的任务.</p>
<p>一般而言,在学习了 playbooks 之后,你才能体会到 Ansible 真正的强大之处在哪里.</p>
<p>那我们会在什么情境下去使用ad-hoc 命令呢?</p>
<p>比如说因为圣诞节要来了,想要把所有实验室的电源关闭,我们只需要执行一行命令
就可以达成这个任务,而不需要写 playbook 来做这个任务.</p>
<p>至于说做配置管理或部署这种事,还是要借助 playbook 来完成,即使用 ‘/usr/bin/ansible-playbook’ 这个命令.</p>
<p>(关于 playbook 的使用,请参考  <a class="reference internal" href="playbooks.html"><span class="doc">Playbooks</span></a> )</p>
<p>如果你还没有阅读 <a class="reference internal" href="intro_inventory.html"><span class="doc">Inventory文件</span></a> ,最好先看一看,然后我们继续往下.</p>
<section id="parallelism-and-shell-commands-1">
<span id="parallelism-and-shell-commands"></span><h2><a class="toc-backref" href="#toc-entry-2" role="doc-backlink">Parallelism and Shell Commands</a><a class="headerlink" href="#parallelism-and-shell-commands-1" title="Permalink to this headline">¶</a></h2>
<p>举一个例子</p>
<p>这里我们要使用 Ansible 的命令行工具来重启 Atlanta 组中所有的 web 服务器,每次重启10个.</p>
<p>我们先设置 SSH-agent,将私钥纳入其管理:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh-agent<span class="w"> </span>bash
$<span class="w"> </span>ssh-add<span class="w"> </span>~/.ssh/id_rsa
</pre></div>
</div>
<p>如果不想使用 ssh-agent, 想通过密码验证的方式使用 SSH,可以在执行ansible命令时使用 <code class="docutils literal notranslate"><span class="pre">--ask-pass</span></code> (<code class="docutils literal notranslate"><span class="pre">-k</span></code>)选项,
但这里建议使用 ssh-agent.</p>
<p>现在执行如下命令,这个命令中,atlanta是一个组,这个组里面有很多服务器,”/sbin/reboot”命令会在atlanta组下
的所有机器上执行.这里ssh-agent会fork出10个子进程(bash),以并行的方式执行reboot命令.如前所说“每次重启10个”
即是以这种方式实现:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>atlanta<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;/sbin/reboot&quot;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">10</span>
</pre></div>
</div>
<p>在执行 /usr/bin/ansible 时,默认是以当前用户的身份去执行这个命令.如果想以指定的用户执行 /usr/bin/ansible,
请添加 “-u username”选项,如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>atlanta<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;/usr/bin/foo&quot;</span><span class="w"> </span>-u<span class="w"> </span>username
</pre></div>
</div>
<p>如果想通过 sudo 去执行命令,如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>atlanta<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;/usr/bin/foo&quot;</span><span class="w"> </span>-u<span class="w"> </span>username<span class="w"> </span>--sudo<span class="w"> </span><span class="o">[</span>--ask-sudo-pass<span class="o">]</span>
</pre></div>
</div>
<p>如果你不是以 passwordless 的模式执行 sudo,应加上 <code class="docutils literal notranslate"><span class="pre">--ask-sudo-pass</span></code> (<code class="docutils literal notranslate"><span class="pre">-K</span></code>)选项,加上之后会提示你输入
密码.使用 passwordless 模式的 sudo, 更容易实现自动化,但不要求一定要使用 passwordless sudo.</p>
<p>也可以通过``–sudo-user`` (<code class="docutils literal notranslate"><span class="pre">-U</span></code>)选项,使用 sudo 切换到其它用户身份,而不是 root(译者注:下面命令中好像写掉了–sudo):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>atlanta<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;/usr/bin/foo&quot;</span><span class="w"> </span>-u<span class="w"> </span>username<span class="w"> </span>-U<span class="w"> </span>otheruser<span class="w"> </span><span class="o">[</span>--ask-sudo-pass<span class="o">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在有些比较罕见的情况下,一些用户会受到安全规则的限制,使用 sudo 切换时只能运行指定的命令.这与 ansible的 no-bootstrapping 思想相悖,而且 ansible 有几百个模块,在这种限制下无法进行正常的工作.
所以执行 ansible 命令时,应使用一个没有受到这种限制的账号来执行.One way of doing this without sharing access to unauthorized users would be gating Ansible with <a class="reference internal" href="tower.html"><span class="doc">Ansible Tower</span></a>, which
can hold on to an SSH credential and let members of certain organizations use it on their behalf without having direct access.</p>
</aside>
<p>以上是关于 ansible 的基础.如果你还没阅读过 patterns 和 groups,应先阅读 <a class="reference internal" href="intro_patterns.html"><span class="doc">Patterns</span></a> .</p>
<p>在前面写出的命令中, <code class="docutils literal notranslate"><span class="pre">-f</span> <span class="pre">10</span></code> 选项表示使用10个并行的进程.这个选项也可以在 <a class="reference internal" href="intro_configuration.html"><span class="doc">Ansible的配置文件</span></a> 中设置,
在配置文件中指定的话,就不用在命令行中写出了.这个选项的默认值是 5,是比较小的.如果同时操作的主机数比较多的话,
可以调整到一个更大的值,只要不超出你系统的承受范围就没问题.如果主机数大于设置的并发进程数,Ansible会自行协调,
花得时间会更长一点.</p>
<p>ansible有许多模块,默认是 ‘command’,也就是命令模块,我们可以通过 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 选项来指定不同的模块.在前面所示的例子中,
因为我们是要在 Atlanta 组下的服务器中执行 reboot 命令,所以就不需要显示的用这个选项指定 ‘command’ 模块,使用
默认设定就OK了.一会在其他例子中,我们会使用 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 运行其他的模块,详情参见 <a class="reference internal" href="modules.html"><span class="doc">模块相关</span></a> .</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="xref std std-ref">command</span> 模块不支持 shell 变量,也不支持管道等 shell 相关的东西.如果你想使用 shell相关的这些东西, 请使用’shell’ 模块.两个模块之前的差别请参考 <a class="reference internal" href="modules.html"><span class="doc">模块相关</span></a> .</p>
</aside>
<p>使用 <span class="xref std std-ref">shell</span> 模块的示例如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>raleigh<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;echo $TERM&#39;</span>
</pre></div>
</div>
<p>使用 Ansible <em>ad hoc</em> 命令行接口时(与使用 <a class="reference internal" href="playbooks.html"><span class="doc">Playbooks</span></a> 的情况相反),尤其注意 shell 引号的规则.
比如在上面的例子中,如果使用双引号”echo $TERM”,会求出TERM变量在当前系统的值,而我们实际希望的是把这个命令传递
到其它机器执行.</p>
<p>在此我们已经演示了一些简单命令如何去执行,但通常来讲大多数 Ansible 模块的工作方式与简单的脚本不同.They make the remote
system look like you state, and run the commands necessary to get it there.这一般被称为 ‘idempotence’,
是 Ansible 设计的核心目标.但我们也认识到,能运行任意命令也是重要的,所以 Ansible 对这两者都做支持.</p>
</section>
<section id="file-transfer-1">
<span id="file-transfer"></span><h2><a class="toc-backref" href="#toc-entry-3" role="doc-backlink">File Transfer</a><a class="headerlink" href="#file-transfer-1" title="Permalink to this headline">¶</a></h2>
<p>这是 <cite>/usr/bin/ansible</cite> 的另一种用法.Ansible 能够以并行的方式同时 SCP 大量的文件到多台机器.
命令如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>atlanta<span class="w"> </span>-m<span class="w"> </span>copy<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;src=/etc/hosts dest=/tmp/hosts&quot;</span>
</pre></div>
</div>
<p>若你使用 playbooks, 则可以利用 <code class="docutils literal notranslate"><span class="pre">template</span></code> 模块来做到更进一步的事情.(请参见 module 和 playbook 的文档)</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">file</span></code> 模块可以做到修改文件的属主和权限,(在这里可替换为 <code class="docutils literal notranslate"><span class="pre">copy</span></code> 模块,是等效的):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>file<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;dest=/srv/foo/a.txt mode=600&quot;</span>
$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>file<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&quot;</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">file</span></code> 模块也可以创建目录,与执行 <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span></code> 效果类似:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>file<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&quot;</span>
</pre></div>
</div>
<p>删除目录(递归的删除)和删除文件:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>file<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;dest=/path/to/c state=absent&quot;</span>
</pre></div>
</div>
</section>
<section id="managing-packages-1">
<span id="managing-packages"></span><h2><a class="toc-backref" href="#toc-entry-4" role="doc-backlink">Managing Packages</a><a class="headerlink" href="#managing-packages-1" title="Permalink to this headline">¶</a></h2>
<p>Ansible 提供对 yum 和 apt 的支持.这里是关于 yum 的示例.</p>
<p>确认一个软件包已经安装,但不去升级它:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>yum<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=acme state=present&quot;</span>
</pre></div>
</div>
<p>确认一个软件包的安装版本:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>yum<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=acme-1.5 state=present&quot;</span>
</pre></div>
</div>
<p>确认一个软件包还没有安装:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>yum<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=acme state=absent&quot;</span>
</pre></div>
</div>
<p>对于不同平台的软件包管理工具,Ansible都有对应的模块.如果没有,你也可以使用 command 模块去安装软件.
或者最好是来为那个软件包管理工具贡献一个相应的模块.请在 mailing list 中查看相关的信息和详情.</p>
</section>
<section id="users-and-groups-1">
<span id="users-and-groups"></span><h2><a class="toc-backref" href="#toc-entry-5" role="doc-backlink">Users and Groups</a><a class="headerlink" href="#users-and-groups-1" title="Permalink to this headline">¶</a></h2>
<p>使用 ‘user’ 模块可以方便的创建账户,删除账户,或是管理现有的账户:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>user<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=foo password=&lt;crypted password here&gt;&quot;</span>

$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>user<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=foo state=absent&quot;</span>
</pre></div>
</div>
<p>更多可用的选项请参考 <a class="reference internal" href="modules.html"><span class="doc">模块相关</span></a> ,包括对组和组成员关系的操作.</p>
</section>
<section id="deploying-from-source-control">
<span id="from-source-control"></span><h2><a class="toc-backref" href="#toc-entry-6" role="doc-backlink">Deploying From Source Control</a><a class="headerlink" href="#deploying-from-source-control" title="Permalink to this headline">¶</a></h2>
<p>直接使用 git 部署 webapp:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>git<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;repo=git://foo.example.org/repo.git dest=/srv/myapp version=HEAD&quot;</span>
</pre></div>
</div>
<p>因为Ansible 模块可通知到 change handlers ,所以当源码被更新时,我们可以告知 Ansible 这个信息,并执行指定的任务,
比如直接通过 git 部署 Perl/Python/PHP/Ruby, 部署完成后重启 apache.</p>
</section>
<section id="managing-services-1">
<span id="managing-services"></span><h2><a class="toc-backref" href="#toc-entry-7" role="doc-backlink">Managing Services</a><a class="headerlink" href="#managing-services-1" title="Permalink to this headline">¶</a></h2>
<p>确认某个服务在所有的webservers上都已经启动:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>service<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=httpd state=started&quot;</span>
</pre></div>
</div>
<p>或是在所有的webservers上重启某个服务(译者注:可能是确认已重启的状态?):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>service<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=httpd state=restarted&quot;</span>
</pre></div>
</div>
<p>确认某个服务已经停止:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>webservers<span class="w"> </span>-m<span class="w"> </span>service<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;name=httpd state=stopped&quot;</span>
</pre></div>
</div>
</section>
<section id="time-limited-background-operations-1">
<span id="time-limited-background-operations"></span><h2><a class="toc-backref" href="#toc-entry-8" role="doc-backlink">Time Limited Background Operations</a><a class="headerlink" href="#time-limited-background-operations-1" title="Permalink to this headline">¶</a></h2>
<p>需要长时间运行的命令可以放到后台去,在命令开始运行后我们也可以检查运行的状态.如果运行命令后,不想获取返回的信息,
可执行如下命令:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-B<span class="w"> </span><span class="m">3600</span><span class="w"> </span>-P<span class="w"> </span><span class="m">0</span><span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<p>如果你确定要在命令运行后检查运行的状态,可以使用 async_status 模块.前面执行后台命令后会返回一个 job id,
将这个 id 传给 async_status 模块:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>web1.example.com<span class="w"> </span>-m<span class="w"> </span>async_status<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;jid=488359678239.2844&quot;</span>
</pre></div>
</div>
<p>获取状态的命令如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-B<span class="w"> </span><span class="m">1800</span><span class="w"> </span>-P<span class="w"> </span><span class="m">60</span><span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">-B</span> <span class="pre">1800</span></code> 表示最多运行30分钟, <code class="docutils literal notranslate"><span class="pre">-P</span> <span class="pre">60</span></code> 表示每隔60秒获取一次状态信息.</p>
<p>Polling 获取状态信息的操作会在后台工作任务启动之后开始.若你希望所有的工作任务快速启动, <code class="docutils literal notranslate"><span class="pre">--forks</span></code> 这个选项的值
要设置得足够大,这是前面讲过的并发进程的个数.在运行指定的时间(由``-B``选项所指定)后,远程节点上的任务进程便会被终止.</p>
<p>一般你只能在把需要长时间运行的命令或是软件升级这样的任务放到后台去执行.对于 copy 模块来说,即使按照前面的示例想放到
后台执行文件传输,实际上并不会如你所愿.</p>
</section>
<section id="gathering-facts">
<span id="checking-facts"></span><h2><a class="toc-backref" href="#toc-entry-9" role="doc-backlink">Gathering Facts</a><a class="headerlink" href="#gathering-facts" title="Permalink to this headline">¶</a></h2>
<p>在 playbooks 中有对于 Facts 做描述,它代表的是一个系统中已发现的变量.These can be used to implement conditional execution
of tasks but also just to get ad-hoc information about your system. 可通过如下方式查看所有的 facts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>setup
</pre></div>
</div>
<p>我们也可以对这个命令的输出做过滤,只输出特定的一些 facts,详情请参考 “setup” 模块的文档.</p>
<p>如果你已准备好仔细研究 <a class="reference internal" href="playbooks.html"><span class="doc">Playbooks</span></a> ,可以继续读读 <a class="reference internal" href="playbooks_variables.html"><span class="doc">Variables</span></a> ,会对 facts有更多了解.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="intro_configuration.html"><span class="doc">Ansible的配置文件</span></a></dt><dd><p>All about the Ansible config file</p>
</dd>
<dt><a class="reference internal" href="modules.html"><span class="doc">模块相关</span></a></dt><dd><p>A list of available modules</p>
</dd>
<dt><a class="reference internal" href="playbooks.html"><span class="doc">Playbooks</span></a></dt><dd><p>Using Ansible for configuration management &amp; deployment</p>
</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt><dd><p>Questions? Help? Ideas?  Stop by the list on Google Groups</p>
</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt><dd><p>#ansible IRC chat channel</p>
</dd>
</dl>
</aside>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="intro_patterns.html" class="btn btn-neutral float-left" title="Patterns" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="intro_configuration.html" class="btn btn-neutral float-right" title="Ansible的配置文件" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, http://www.magedu.com, 马哥Linux团队成员荣誉出品(薛定谔的章鱼 &amp; guli &amp; 以马内利 &amp; 黄博文 &amp; coocla &amp; 云中鹤 &amp; stanley) 官方QQ交流群:372011984.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>